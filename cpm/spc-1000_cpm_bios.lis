                  ;	Z80 CBIOS for SPC-1000
                  ;
                  ;	Copyright (C) 1988-2007 by Udo Munk
                  ;	Copyright (C) 2014 by Miso Kim
                  ;
MSIZE   EQU 58                          ;003a              ;cp/m version memory size in kilobytes
                  ;	include "spc-1000_all.inc"
                  ;ACCPRT  	EQU 00864H
                  ;ASCGET  	EQU 00C62H
                  ;ACCOUT  	EQU 008D9H
                  ;ACCDIS  	EQU 008DEH
                  ;GACPRT  	EQU 0094FH
                  ;CR1     	EQU 00843H
                  ;CR2     	EQU 00823H
KEYBUF      EQU 07A4FH                  ;7a4f              
                  ;
                  ;	"bias" is address offset from 3400H for memory systems
                  ;	than 16K (referred to as "b" throughout the text).
                  ;
BIAS    EQU (MSIZE-20)*1024             ;9800              
CCP     EQU 3400H+BIAS                  ;cc00              ;base of ccp
BDOS    EQU CCP+806H                    ;d406              ;base of bdos
BIOS    EQU CCP+1600H                   ;e200              ;base of bios
NSECTS  EQU (BIOS-CCP)/128              ;002c              ;warm start sector count
CDISK   EQU 0004H                       ;0004              ;current disk number 0=A,...,15=P
IOBYTE  EQU 0003H                       ;0003              ;intel i/o byte
                  ;
                  ;	I/O ports
                  ;
CONSTA  EQU 0                           ;0000              ;console status port
CONDAT  EQU 1                           ;0001              ;console data port
PRTSTA  EQU 2                           ;0002              ;printer status port
PRTDAT  EQU 3                           ;0003              ;printer data port
AUXDAT  EQU 5                           ;0005              ;auxiliary data port
FDCD    EQU 10                          ;000a              ;fdc-port: # of drive
FDCT    EQU 11                          ;000b              ;fdc-port: # of track
FDCS    EQU 12                          ;000c              ;fdc-port: # of sector
FDCOP   EQU 13                          ;000d              ;fdc-port: command
FDCST   EQU 14                          ;000e              ;fdc-port: status
DMAL    EQU 15                          ;000f              ;dma-port: dma address low
DMAH    EQU 16                          ;0010              ;dma-port: dma address high
                  ;
    ORG BIOS                            ;                  ;origin of this program
                  ;
                  ;	jump vector for individual subroutines
                  ;
    JP  BOOT                            ;e200  c3 d0 e2    ;cold start
WBOOTE: JP  WBOOT                       ;e203  c3 f9 e2    ;warm start
    JP  CONST                           ;e206  c3 64 e3    ;console status
    JP  CONIN                           ;e209  c3 6c e3    ;console character in
    JP  CONOUT                          ;e20c  c3 70 e3    ;console character out
    JP  LIST                            ;e20f  c3 77 e3    ;list character out
    JP  PUNCHS                          ;e212  c3 7c e3    ;punch character out
    JP  READER                          ;e215  c3 7e e3    ;reader character in
    JP  HOME                            ;e218  c3 7f e3    ;move head to home position
    JP  SELDSK                          ;e21b  c3 84 e3    ;select disk
    JP  SETTRK                          ;e21e  c3 a8 e3    ;set track number
    JP  SETSEC                          ;e221  c3 b7 e3    ;set sector number
    JP  SETDMA                          ;e224  c3 e0 e3    ;set dma address
    JP  READ                            ;e227  c3 e5 e3    ;read disk
    JP  WRITE                           ;e22a  c3 3b e4    ;write disk
    JP  LISTST                          ;e22d  c3 79 e3    ;return list status
    JP  SECTRAN                         ;e230  c3 cf e3    ;sector translate
                  ;
                  ;	fixed data tables for four-drive standard
                  ;	IBM-compatible 8" SD disks
                  ;
                  ;	disk parameter header for disk 00
DPBASE:                                 ;                  
    DEFW    0000H,0000H                 ;e233  00 00 00 00 
    DEFW    0000H,0000H                 ;e237  00 00 00 00 
    DEFW    DIRBF,DPBLK                 ;e23b  13 ec 6d e2 
    DEFW    CHK00,ALL00                 ;e23f  0d ef 93 ec 
                  ;	disk parameter header for disk 01
    DEFW    0000H,0000H                 ;e243  00 00 00 00 
    DEFW    0000H,0000H                 ;e247  00 00 00 00 
    DEFW    DIRBF,DPBLK                 ;e24b  13 ec 6d e2 
    DEFW    CHK01,ALL01                 ;e24f  1d ef b2 ec 
                  ;
                  ;	sector translate vector for the IBM 8" SD disks
                  ;
TRANS:                                  ;                  
    DEFB    1,7,13,19                   ;e253  01 07 0d 13 ;sectors 1,2,3,4
    DEFB    25,5,11,17                  ;e257  19 05 0b 11 ;sectors 5,6,7,8
    DEFB    23,3,9,15                   ;e25b  17 03 09 0f ;sectors 9,10,11,12
    DEFB    21,2,8,14                   ;e25f  15 02 08 0e ;sectors 13,14,15,16
    DEFB    20,26,6,12                  ;e263  14 1a 06 0c ;sectors 17,18,19,20
    DEFB    18,24,4,10                  ;e267  12 18 04 0a ;sectors 21,22,23,24
    DEFB    16,22                       ;e26b  10 16       ;sectors 25,26
                  ;
                  ;	disk parameter block, SD725 (from TF-20)
                  ;
DPBLK:                                  ;                  
    DEFW    32                          ;e26d  20 00       ;sectors per track
    DEFB    4                           ;e26f  04          ;block shift factor
    DEFB    15                          ;e270  0f          ;block mask
    DEFB    1                           ;e271  01          ;extent mask
    DEFW    153                         ;e272  99 00       ;disk size-1
    DEFW    127                         ;e274  7f 00       ;directory max
    DEFB    0C0H                        ;e276  c0          ;alloc 0
    DEFB    0                           ;e277  00          ;alloc 1
    DEFW    32                          ;e278  20 00       ;check size
    DEFW    3                           ;e27a  03 00       ;track offset
                  ;
                  ;	messages
                  ;
SIGNON:                                 ;                  
    DEFM    '58K CP/M Version 2.2'      ;e27c  35 38 4b 20 
                                        ;e280  43 50 2f 4d    108    109
                                        ;e284  20 56 65 72    108    110
                                        ;e288  73 69 6f 6e    108    111
                                        ;e28c  20 32 2e 32    108    112
    DEFB    13,10                       ;e290  0d 0a       
    DEFM    '(for SPC-1000 with SD-725)';e292  28 66 6f 72 
                                        ;e296  20 53 50 43    110    115
                                        ;e29a  2d 31 30 30    110    116
                                        ;e29e  30 20 77 69    110    117
                                        ;e2a2  74 68 20 53    110    118
                                        ;e2a6  44 2d 37 32    110    119
                                        ;e2aa  35 29          110    120
    DEFB    13,10,0                     ;e2ac  0d 0a 00    
                  ;
LDERR:                                  ;                  
    DEFM    'BIOS: error booting'       ;e2af  42 49 4f 53 
                                        ;e2b3  3a 20 65 72    114    125
                                        ;e2b7  72 6f 72 20    114    126
                                        ;e2bb  62 6f 6f 74    114    127
                                        ;e2bf  69 6e 67       114    128
    DEFB    13,10,0                     ;e2c2  0d 0a 00    
                  
                  ;
                  ;	end of fixed tables
                  ;
                  ;	utility functions
                  ;
                  ;	print a 0 terminated string to console device
                  ;	pointer to string in HL
                  ;
PRTMSG: LD  A,(HL)                      ;e2c5  7e          
    OR  A                               ;e2c6  b7          
    RET Z                               ;e2c7  c8          
    LD  C,A                             ;e2c8  4f          
    CALL    CONOUT                      ;e2c9  cd 70 e3    
    INC HL                              ;e2cc  23          
    JP  PRTMSG                          ;e2cd  c3 c5 e2    
                  ;
                  ;	individual subroutines to perform each function
                  ;	simplest case is to just perform parameter initialization
                  ;
BOOT:                                   ;                  
    LD  SP,80H                          ;e2d0  31 80 00    ;use space below buffer for stack
    XOR A                               ;e2d3  af          
    LD  BC, 06000h                      ;e2d4  01 00 60    
    OUT (C), A                          ;e2d7  ed 79       
    ld  a, 8eh                          ;e2d9  3e 8e       
    LD  BC, 02000h                      ;e2db  01 00 20    
    OUT (C), a                          ;e2de  ed 79       
    DEC BC                              ;e2e0  0b          
CLS3:                                   ;                  
    XOR A                               ;e2e1  af          
    OUT (C), A                          ;e2e2  ed 79       
    DEC BC                              ;e2e4  0b          
    LD  A,B                             ;e2e5  78          
    OR  C                               ;e2e6  b1          
    JR  NZ, CLS3                        ;e2e7  20 f8       
    LD  HL,SIGNON                       ;e2e9  21 7c e2    ;print message
    CALL    PRTMSG                      ;e2ec  cd c5 e2    
    XOR A                               ;e2ef  af          ;zero in the accum
    LD  (IOBYTE),A                      ;e2f0  32 03 00    ;clear the iobyte
    LD  (CDISK),A                       ;e2f3  32 04 00    ;select disk zero
    JP  GOCPM                           ;e2f6  c3 43 e3    ;initialize and go to cp/m
                  ;
                  ;	simplest case is to read the disk until all sectors loaded
                  ;
WBOOT:  LD  SP,80H                      ;e2f9  31 80 00    ;use space below buffer for stack
    LD  C,0                             ;e2fc  0e 00       ;select disk 0
    CALL    SELDSK                      ;e2fe  cd 84 e3    
    CALL    HOME                        ;e301  cd 7f e3    ;go to track 00
                  ;
    LD  B,NSECTS                        ;e304  06 2c       ;b counts # of sectors to load
    LD  C,0                             ;e306  0e 00       ;c has the current track number
    LD  D,4                             ;e308  16 04       ;d has the next sector to read
                  ;	note that we begin by reading track 0, sector 2 since sector 1
                  ;	contains the cold start loader, which is skipped in a warm start
    LD  HL,CCP                          ;e30a  21 00 cc    ;base of cp/m (initial load point)
LOAD1:                                  ;                  ;load one more sector
    PUSH    BC                          ;e30d  c5          ;save sector count, current track
    PUSH    DE                          ;e30e  d5          ;save next sector to read
    PUSH    HL                          ;e30f  e5          ;save dma address
    LD  C,D                             ;e310  4a          ;get sector address to register c
    CALL    SETSEC                      ;e311  cd b7 e3    ;set sector address from register c
    POP BC                              ;e314  c1          ;recall dma address to b,c
    PUSH    BC                          ;e315  c5          ;replace on stack for later recall
    CALL    SETDMA                      ;e316  cd e0 e3    ;set dma address from b,c
                  ;	drive set to 0, track set, sector set, dma address set
    CALL    READ                        ;e319  cd e5 e3    
    OR  A                               ;e31c  b7          ;any errors?
    JP  Z,LOAD2                         ;e31d  ca 28 e3    ;no, continue
    LD  HL,LDERR                        ;e320  21 af e2    ;error, print message
    CALL    PRTMSG                      ;e323  cd c5 e2    
    DI                                  ;e326  f3          ;and halt the machine
    HALT                                ;e327  76          
                  ;	no error, move to next sector
LOAD2:  POP HL                          ;e328  e1          ;recall dma address
    LD  DE,128                          ;e329  11 80 00    ;dma=dma+128
    ADD HL,DE                           ;e32c  19          ;new dma address is in h,l
    POP DE                              ;e32d  d1          ;recall sector address
    POP BC                              ;e32e  c1          ;recall number of sectors remaining,
                                        ;                  ;and current trk
    DEC B                               ;e32f  05          ;sectors=sectors-1
    JP  Z,GOCPM                         ;e330  ca 43 e3    ;transfer to cp/m if all have been loaded
                  ;	more sectors remain to load, check for track change
    INC D                               ;e333  14          
    LD  A,D                             ;e334  7a          ;sector=27?, if so, change tracks
    CP  31                              ;e335  fe 1f       
    JP  C,LOAD1                         ;e337  da 0d e3    ;carry generated if sector<27
                  ;	end of current track, go to next track
    LD  D,1                             ;e33a  16 01       ;begin with first sector of next track
    INC C                               ;e33c  0c          ;track=track+1
                  ;	save register state, and change tracks
    CALL    SETTRK                      ;e33d  cd a8 e3    ;track address set from register c
    JP  LOAD1                           ;e340  c3 0d e3    ;for another sector
                  ;	end of load operation, set parameters and go to cp/m
GOCPM:                                  ;                  
    LD  A,0C3H                          ;e343  3e c3       ;c3 is a jmp instruction
    LD  (0),A                           ;e345  32 00 00    ;for jmp to wboot
    LD  HL,WBOOTE                       ;e348  21 03 e2    ;wboot entry point
    LD  (1),HL                          ;e34b  22 01 00    ;set address field for jmp at 0
                  ;
    LD  (5),A                           ;e34e  32 05 00    ;for jmp to bdos
    LD  HL,BDOS                         ;e351  21 06 d4    ;bdos entry point
    LD  (6),HL                          ;e354  22 06 00    ;address field of jump at 5 to bdos
                  ;
    LD  BC,80H                          ;e357  01 80 00    ;default dma address is 80h
    CALL    SETDMA                      ;e35a  cd e0 e3    
                  ;
    LD  A,(CDISK)                       ;e35d  3a 04 00    ;get current disk number
    LD  C,A                             ;e360  4f          ;send to the ccp
    JP  CCP                             ;e361  c3 00 cc    ;go to cp/m for further processing
                  ;
                  ;
                  ;	simple i/o handlers
                  ;
                  ;	console status, return 0ffh if character ready, 00h if not
                  ;
CONST:                                  ;                  
                  ;    IN	A,(CONSTA)	;get console status
    LD A, (KEYBUF)                      ;e364  3a 4f 7a    
    OR A                                ;e367  b7          
    RET NZ                              ;e368  c0          
    LD A, 0ffh                          ;e369  3e ff       
    RET                                 ;e36b  c9          
                  ;
                  ;	console character into register a
                  ;
CONIN:                                  ;                  
                  ;	IN	A,(CONDAT)	;get character from console
    CALL ASCGET1                        ;e36c  cd 1b e5    ; SPC-1000 IOCS
    RET                                 ;e36f  c9          
                  ;
                  ;	console character output from register c
                  ;
CONOUT:                                 ;                  
    LD  A,C                             ;e370  79          ;get to accumulator
                  ;	OUT	(CONDAT),A	;send character to console
                  ;	CP 13
                  ;	JR NZ, ASCPRT
                  ;	CALL CR2
                  ;	RET
ASCPRT:                                 ;                  
    PUSH HL                             ;e371  e5          
    CALL ACCPRT1                        ;e372  cd a8 e7    
    POP  HL                             ;e375  e1          
    RET                                 ;e376  c9          
                  ;
                  ;	list character from register c
                  ;
LIST:   LD  A,C                         ;e377  79          ;character to register a
                  ;	OUT	(PRTDAT),A
                                        ;                  
    RET                                 ;e378  c9          
                  ;
                  ;	return list status (00h if not ready, 0ffh if ready)
                  ;
LISTST:                                 ;                  
                  ;	IN	A,(PRTSTA)
    LD  A, 0                            ;e379  3e 00       
    RET                                 ;e37b  c9          
                  ;
                  ;	punch character from register c
                  ;
PUNCHS:                                 ;                  
    LD  A,C                             ;e37c  79          ;character to register a
                  ;	OUT	(AUXDAT),A
    RET                                 ;e37d  c9          
                  ;
                  ;	read character into register a from reader device
                  ;
READER:                                 ;                  
                  ;	IN	A,(AUXDAT)
    RET                                 ;e37e  c9          
                  ;
                  ;
                  ;	i/o drivers for the disk follow
                  ;
                  ;	move to the track 00 position of current drive
                  ;	translate this call into a settrk call with parameter 00
                  ;
HOME:   LD  C,0                         ;e37f  0e 00       ;select track 0
    JP  SETTRK                          ;e381  c3 a8 e3    ;we will move to 00 on first read/write
                  ;
                  ;	select disk given by register C
                  ;
SELDSK: LD  HL,0000H                    ;e384  21 00 00    ;error return code
    LD  A,C                             ;e387  79          
    CP  2                               ;e388  fe 02       ;FD drive 0-1?
    JR  C,SELFD                         ;e38a  38 01       ;go
    RET                                 ;e38c  c9          ;no, error
                  ;	disk number is in the proper range
                  ;	compute proper disk parameter header address
SELFD:                                  ;                  
    LD  C,A                             ;e38d  4f          
    LD  A,(FDD#D)                       ;e38e  3a 0d e5    
    CP  C                               ;e391  b9          
    JR  Z,SELFD$                        ;e392  28 05       
    LD HL,CHGFLG                        ;e394  21 12 e5    
    SET 2,(HL)                          ;e397  cb d6       
SELFD$:                                 ;                  
    LD H,0                              ;e399  26 00       
    LD (FDD#D),A                        ;e39b  32 0d e5    
    LD  L,A                             ;e39e  6f          ;L=disk number 0,1,2,3
    ADD HL,HL                           ;e39f  29          ;*2
    ADD HL,HL                           ;e3a0  29          ;*4
    ADD HL,HL                           ;e3a1  29          ;*8
    ADD HL,HL                           ;e3a2  29          ;*16 (size of each header)
    LD  DE,DPBASE                       ;e3a3  11 33 e2    
    ADD HL,DE                           ;e3a6  19          ;HL=.dpbase(diskno*16)
    RET                                 ;e3a7  c9          
                  ;
                  ;	set track given by register c
                  ;
SETTRK:                                 ;                  
                  ;	LD	A,C
                  ;	OUT	(FDCT),A
    LD A,(FDD#T)                        ;e3a8  3a 0e e5    
    CP C                                ;e3ab  b9          
    RET Z                               ;e3ac  c8          
    LD HL,CHGFLG                        ;e3ad  21 12 e5    
    SET 1,(HL)                          ;e3b0  cb ce       
    LD  A,C                             ;e3b2  79          
    LD (FDD#T),A                        ;e3b3  32 0e e5    
    RET                                 ;e3b6  c9          
                  ;
                  ;	set sector given by register c
                  ;
SETSEC:                                 ;                  
                  ;	LD	A,C
                  ;	OUT	(FDCS),A
    DEC C                               ;e3b7  0d          
    LD B,C                              ;e3b8  41          
    XOR A                               ;e3b9  af          
    LD A,(FDD#S)                        ;e3ba  3a 0f e5    
    RR A                                ;e3bd  cb 1f       
    OR A                                ;e3bf  b7          
    RR C                                ;e3c0  cb 19       
    CP C                                ;e3c2  b9          
    JR Z, SETSEC0                       ;e3c3  28 05       
    LD HL,CHGFLG                        ;e3c5  21 12 e5    
    SET 0,(HL)                          ;e3c8  cb c6       
SETSEC0:                                ;                  
    LD  A,B                             ;e3ca  78          
    LD (FDD#S),A                        ;e3cb  32 0f e5    
    RET                                 ;e3ce  c9          
                  ;
                  ;	translate the sector given by BC using the
                  ;	translate table given by DE
                  ;
SECTRAN:                                ;                  
    LD  A,D                             ;e3cf  7a          ;do we have a translation table?
    OR  E                               ;e3d0  b3          
    JP  NZ,SECT1                        ;e3d1  c2 da e3    ;yes, translate
    LD  L,C                             ;e3d4  69          ;no, return untranslated
    LD  H,B                             ;e3d5  60          ;in HL
    INC L                               ;e3d6  2c          ;sector no. start with 1
    RET NZ                              ;e3d7  c0          
    INC H                               ;e3d8  24          
    RET                                 ;e3d9  c9          
SECT1:  EX  DE,HL                       ;e3da  eb          ;HL=.trans
    ADD HL,BC                           ;e3db  09          ;HL=.trans(sector)
    LD  L,(HL)                          ;e3dc  6e          ;L = trans(sector)
    LD  H,0                             ;e3dd  26 00       ;HL= trans(sector)
    RET                                 ;e3df  c9          ;with data in HL
                  ;
                  ;	set dma address given by registers b and c
                  ;
SETDMA:                                 ;                  
                  ;	LD	A,C		;low order address
                  ;	OUT	(DMAL),A
                  ;	LD	A,B		;high order address
                  ;	OUT	(DMAH),A	;in dma
    LD (DATADDR), BC                    ;e3e0  ed 43 10 e5 
    RET                                 ;e3e4  c9          
                  ;
                  ;	perform read operation
                  ;
READ:                                   ;                  
                  ;	XOR	A		;read command -> A
                  ;	JP	WAITIO		;to perform the actual i/o
    LD A,(CHGFLG)                       ;e3e5  3a 12 e5    
    CP 0                                ;e3e8  fe 00       
    JR NZ, REALREAD                     ;e3ea  20 06       
BUFCHECK:                               ;                  
    LD A,(FDD#S)                        ;e3ec  3a 0f e5    
    RRA                                 ;e3ef  1f          
    JR BUFCOPY                          ;e3f0  18 35       
REALREAD:                               ;                  
    LD  D, SDREAD                       ;e3f2  16 02       
    CALL    SENDCOM                     ;e3f4  cd a6 e4    
    LD  HL,FDD#N                        ;e3f7  21 0c e5    ; FDD#N
    LD  D,(HL)                          ;e3fa  56          
    LD  B,D                             ;e3fb  42          
    LD  C,0                             ;e3fc  0e 00       
    PUSH BC                             ;e3fe  c5          
    CALL    SENDDAT                     ;e3ff  cd ae e4    
    INC HL                              ;e402  23          ; FDD#D
    LD  D,(HL)                          ;e403  56          
    CALL    SENDDAT                     ;e404  cd ae e4    
    INC HL                              ;e407  23          ; FDD#T
    LD  D,(HL)                          ;e408  56          
    CALL    SENDDAT                     ;e409  cd ae e4    
    INC HL                              ;e40c  23          ; FDD#S
    LD  A,(HL)                          ;e40d  7e          
    RRA                                 ;e40e  1f          
    LD  D,A                             ;e40f  57          
    INC D                               ;e410  14          
    CALL    SENDDAT                     ;e411  cd ae e4    
    LD  D,03h                           ;e414  16 03       
    CALL    SENDCOM                     ;e416  cd a6 e4    
    POP BC                              ;e419  c1          
    LD  HL,DISKDATA                     ;e41a  21 ad f5    
SYM1:                                   ;                  
    CALL GETDATA                        ;e41d  cd dd e4    ; from FDD  
    LD (HL),D                           ;e420  72          ; and write to RAM  
    INC HL                              ;e421  23          ; from 0CC00h   
    DEC BC                              ;e422  0b          ;  
    LD A,B                              ;e423  78          ;  
    OR C                                ;e424  b1          ;  
    JR NZ, SYM1                         ;e425  20 f6       ; ------------------  
BUFCOPY:                                ;                  
    LD  HL,DISKDATA                     ;e427  21 ad f5    
    LD  BC,128                          ;e42a  01 80 00    
    JR NC, EVENREAD                     ;e42d  30 01       
ODDREAD:                                ;                  
    ADD HL,BC                           ;e42f  09          
EVENREAD:                               ;                  
    LD  DE,(DATADDR)                    ;e430  ed 5b 10 e5 
    LDIR                                ;e434  ed b0       
    XOR A                               ;e436  af          
    LD (CHGFLG), A                      ;e437  32 12 e5    
    RET                                 ;e43a  c9          
                  ;
                  ;	perform a write operation
                  ;
WRITE:                                  ;                  
                  ;	LD	A,1		;write command -> A
WRITEC:                                 ;                  ; C == 2
    LD  HL,DISKDATA                     ;e43b  21 ad f5    
    LD  A,(FDD#S)                       ;e43e  3a 0f e5    
    OR A                                ;e441  b7          
    RRA                                 ;e442  1f          
    LD  BC, 128                         ;e443  01 80 00    
    JR  NC, EVENWRIT                    ;e446  30 01       
ODDWRIT:                                ;                  
    ADD HL,BC                           ;e448  09          
EVENWRIT:                               ;                  
    LD  DE,(DATADDR)                    ;e449  ed 5b 10 e5 
    EX  DE,HL                           ;e44d  eb          
    LDIR                                ;e44e  ed b0       
CHKWCPY:                                ;                  
CHKWFLG:                                ;                  
WRITEM:                                 ;                  
    LD  D, SDWRITE                      ;e450  16 01       
    CALL    SENDCOM                     ;e452  cd a6 e4    
    LD  HL,FDD#N                        ;e455  21 0c e5    
    LD  D,(HL)                          ;e458  56          
    CALL    SENDDAT                     ;e459  cd ae e4    
    INC HL                              ;e45c  23          
    LD  D,(HL)                          ;e45d  56          
    CALL    SENDDAT                     ;e45e  cd ae e4    
    INC HL                              ;e461  23          
    LD  D,(HL)                          ;e462  56          
    CALL    SENDDAT                     ;e463  cd ae e4    
    INC HL                              ;e466  23          
    LD  A,(HL)                          ;e467  7e          
    OR A                                ;e468  b7          
    RR A                                ;e469  cb 1f       
    LD  D,A                             ;e46b  57          
    INC D                               ;e46c  14          
    CALL    SENDDAT                     ;e46d  cd ae e4    
    LD  HL,DISKDATA                     ;e470  21 ad f5    
    LD  D,H                             ;e473  54          
    CALL    SENDDAT                     ;e474  cd ae e4    
    LD  D,L                             ;e477  55          
    CALL    SENDDAT                     ;e478  cd ae e4    
    XOR A                               ;e47b  af          
    RET                                 ;e47c  c9          
                                        ;                  
READ1:                                  ;                  ;                     354    368 ;	JP	WAITIO		;to perform the actual i/o
    LD  D, SDLOAD                       ;e47d  16 0e       ;e3aa  16 0e          355    369 
    CALL    SENDCOM                     ;e47f  cd a6 e4    ;e3ac  cd 01 e4       356    370 
    LD  HL,FDD#N                        ;e482  21 0c e5    ;e3af  21 67 e4       357    371 
    LD  D,(HL)                          ;e485  56          ;e3b2  56             358    372 
    CALL    SENDDAT                     ;e486  cd ae e4    ;e3b3  cd 09 e4       359    373 
    INC HL                              ;e489  23          ;e3b6  23             360    374 
    LD  D,(HL)                          ;e48a  56          ;e3b7  56             361    375 
    CALL    SENDDAT                     ;e48b  cd ae e4    ;e3b8  cd 09 e4       362    376 
    INC HL                              ;e48e  23          ;e3bb  23             363    377 
    LD  D,(HL)                          ;e48f  56          ;e3bc  56             364    378 
    CALL    SENDDAT                     ;e490  cd ae e4    ;e3bd  cd 09 e4       365    379 
    INC HL                              ;e493  23          ;e3c0  23             366    380 
    LD  D,(HL)                          ;e494  56          ;e3c1  56             367    381 
    CALL    SENDDAT                     ;e495  cd ae e4    ;e3c3  cd 09 e4       369    383 
    LD  HL,DATADDR+1                    ;e498  21 11 e5    ;e3c6  21 6c e4       370    384 
    LD  D,(HL)                          ;e49b  56          ;e3c9  56             371    385 
    CALL    SENDDAT                     ;e49c  cd ae e4    ;e3ca  cd 09 e4       372    386 
    DEC HL                              ;e49f  2b          ;e3cd  2b             373    387 
    LD  D,(HL)                          ;e4a0  56          ;e3ce  56             374    388 
    CALL    SENDDAT                     ;e4a1  cd ae e4    ;e3cf  cd 09 e4       375    389 
    RET                                 ;e4a4  c9          ;e3d2  c9             376    390 
                  
                  ;
                  ;	enter here from read and write to perform the actual i/o
                  ;	operation.  return a 00h in register a if the operation completes
                  ;	properly, and 01h if an error occurs during the read or write
                  ;
WAITIO:                                 ;                  
                  ;   OUT	(FDCOP),A	;start i/o operation
                  ;	IN	A,(FDCST)	;status of i/o operation -> A
    RET                                 ;e4a5  c9          
                  
SDINIT      EQU 0                       ;0000              
SDWRITE     EQU 1                       ;0001              
SDREAD      EQU 2                       ;0002              
SDSEND      EQU 3                       ;0003              
SDCOPY      EQU 4                       ;0004              
SDFORMAT    EQU 5                       ;0005              
SDSTATUS    EQU 6                       ;0006              
SDDRVSTS    EQU 7                       ;0007              
SDRAMTST    EQU 8                       ;0008              
SDTRANS2    EQU 9                       ;0009              
SDNOACT     EQU 0Ah                     ;000a              
SDTRANS1    EQU 0Bh                     ;000b              
SDRCVE      EQU 0Ch                     ;000c              
SDGO        EQU 0Dh                     ;000d              
SDLOAD      EQU 0Eh                     ;000e              
SDSAVE      EQU 0Fh                     ;000f              
SDLDNGO     EQU 010h                    ;0010              
                  
                                        ;                  
                  ;
                  ;   SPC-1000 FDD command I/O
                  ;
SENDCOM:                                ;                  
    LD  B,0C0h                          ;e4a6  06 c0       ;
    LD  C,002h                          ;e4a8  0e 02       ;
    LD  A,080h                          ;e4aa  3e 80       ;
    OUT (C),A                           ;e4ac  ed 79       ;
SENDDAT:                                ;                  
    LD  B,0C0h                          ;e4ae  06 c0       ;
    LD  C,002h                          ;e4b0  0e 02       ;
CHKRFD1:    IN  A,(C)                   ;e4b2  ed 78       ;
    AND 002h                            ;e4b4  e6 02       ;
    JR  Z,CHKRFD1                       ;e4b6  28 fa       ;
    LD  C,002h                          ;e4b8  0e 02       ;
    XOR A                               ;e4ba  af          ;
    OUT (C),A                           ;e4bb  ed 79       ; ATN=0
    LD  C,000h                          ;e4bd  0e 00       ;
    OUT (C),D                           ;e4bf  ed 51       ;
    LD  C,002h                          ;e4c1  0e 02       ;
    LD  A,010h                          ;e4c3  3e 10       ;
    OUT (C),A                           ;e4c5  ed 79       ;
    LD  C,002h                          ;e4c7  0e 02       ;
CHKDAC2:    IN  A,(C)                   ;e4c9  ed 78       ;
    AND 004h                            ;e4cb  e6 04       ;
    JR  Z,CHKDAC2                       ;e4cd  28 fa       ;
    LD  C,002h                          ;e4cf  0e 02       ;
    XOR A                               ;e4d1  af          ;
    OUT (C),A                           ;e4d2  ed 79       ;
    LD  C,002h                          ;e4d4  0e 02       ;
CHKDAC3:    IN  A,(C)                   ;e4d6  ed 78       ;
    AND 004h                            ;e4d8  e6 04       ;
    JR  NZ,CHKDAC3                      ;e4da  20 fa       ; 
    RET                                 ;e4dc  c9          ;
GETDATA:                                ;                  
    PUSH    BC                          ;e4dd  c5          ;
    LD  C,002h                          ;e4de  0e 02       ;
    LD  B,0C0h                          ;e4e0  06 c0       ;
    LD  A,020h                          ;e4e2  3e 20       ;
    OUT (C),A                           ;e4e4  ed 79       ;
    LD  C,002h                          ;e4e6  0e 02       ;
CHKDAV0:    IN  A,(C)                   ;e4e8  ed 78       ;
    AND 001h                            ;e4ea  e6 01       ;
    JR  Z,CHKDAV0                       ;e4ec  28 fa       ;
    LD  C,002h                          ;e4ee  0e 02       ;
    XOR A                               ;e4f0  af          ;
    OUT (C),A                           ;e4f1  ed 79       ;
    LD  C,001h                          ;e4f3  0e 01       ;
    IN  D,(C)                           ;e4f5  ed 50       ;
    LD  C,002h                          ;e4f7  0e 02       ;
    LD  A,040h                          ;e4f9  3e 40       ;
    OUT (C),A                           ;e4fb  ed 79       ;
    LD  C,002h                          ;e4fd  0e 02       ;
CHKDAV1:    IN  A,(C)                   ;e4ff  ed 78       ;
    AND 001h                            ;e501  e6 01       ;
    JR  NZ,CHKDAV1                      ;e503  20 fa       ; 
    LD  C,002h                          ;e505  0e 02       ;
    XOR A                               ;e507  af          ;
    OUT (C),A                           ;e508  ed 79       ;
    POP BC                              ;e50a  c1          ;
    RET                                 ;e50b  c9          ;
                                        ;                  
FDD#N:  DEFB    1                       ;e50c  01          
FDD#D:  DEFB    0                       ;e50d  00          
FDD#T:  DEFB    0                       ;e50e  00          
FDD#S:  DEFB    0                       ;e50f  00          
DATADDR:DEFW    0                       ;e510  00 00       
CHGFLG: DEFB    1                       ;e512  01          
PRESEC: DEFB    0xffh                   ;e513  ff          
                                        ;                  
BRKEY:  LD  A,080h                      ;e514  3e 80       
    IN  A,(0)                           ;e516  db 00       
    AND 012h                            ;e518  e6 12       
    RET                                 ;e51a  c9          
                                        ;                  ;
ASCGET1: PUSH    BC                     ;e51b  c5          
    PUSH    DE                          ;e51c  d5          
    PUSH    HL                          ;e51d  e5          
    LD  HL,(POINT1)                     ;e51e  2a 30 eb    
    LD  A,L                             ;e521  7d          
    CP  H                               ;e522  bc          
    JR  Z,BUFSET                        ;e523  28 12       
BUFCEK: INC A                           ;e525  3c          
    AND 03Fh                            ;e526  e6 3f       
    LD  (POINT1),A                      ;e528  32 30 eb    
    LD  L,A                             ;e52b  6f          
    LD  H,0                             ;e52c  26 00       
    LD  DE,INKYBF                       ;e52e  11 4d ef    
    ADD HL,DE                           ;e531  19          
    LD  A,(HL)                          ;e532  7e          
GETRET: POP HL                          ;e533  e1          
    POP DE                              ;e534  d1          
    POP BC                              ;e535  c1          
    RET                                 ;e536  c9          
                                        ;                  ;
BUFSET: DEFB    03Eh                    ;e537  3e          ; LD A,
FLASHF: DEFB    001h                    ;e538  01          ;
    OR  A                               ;e539  b7          
    JR  NZ,FLGET                        ;e53a  20 24       
    CALL    KEYSEN                      ;e53c  cd 0b e6    
    CALL    BRKEY                       ;e53f  cd 14 e5    
    JR  NZ,KEYGT                        ;e542  20 07       
BRKGTR: CALL    NEWFLG                  ;e544  cd 72 e6    
    LD  A,3                             ;e547  3e 03       
    JR  GETRET                          ;e549  18 e8       
KEYGT:  CALL    KEYSEN                  ;e54b  cd 0b e6    
    JR  Z,ZERORT                        ;e54e  28 0a       
    CALL    NEWCEK                      ;e550  cd 4c e6    
    JR  NZ,NEWKYS                       ;e553  20 29       
    CALL    SAMECK                      ;e555  cd 62 e6    
    JR  Z,REPETS                        ;e558  28 16       
ZERORT: CALL    NEWFLG                  ;e55a  cd 72 e6    
ZEROR2: XOR A                           ;e55d  af          
    JR  GETRET                          ;e55e  18 d3       
FLGET:  CALL    FLSHGT                  ;e560  cd cd e5    
    LD  C,A                             ;e563  4f          
    LD  A,080h                          ;e564  3e 80       
    IN  A,(0)                           ;e566  db 00       
    AND 012h                            ;e568  e6 12       
    JR  Z,BRKGTR                        ;e56a  28 d8       
    LD  A,C                             ;e56c  79          
    OR  A                               ;e56d  b7          
    JR  Z,NEWKYS                        ;e56e  28 0e       
REPETS: CALL    NEWFLG                  ;e570  cd 72 e6    
    DEFB    021h                        ;e573  21          ; LD HL,(KEYBFA)
KEYBFA: DEFW    0FFFEh                  ;e574  fe ff       ;
    DEFB    03Eh                        ;e576  3e          ; LD A,(KEYBFD)
KEYBFD: DEFB    000h                    ;e577  00          
    LD  (HL),A                          ;e578  77          
    LD  HL,30                           ;e579  21 1e 00    
    JR  KEYST2                          ;e57c  18 06       
NEWKYS: CALL    NEWFLG                  ;e57e  cd 72 e6    
    DEFB    021h                        ;e581  21          ; LD HL,300
REPTSW: DEFW    200                     ;e582  c8 00       ; auto repeat key duration
KEYST2: LD  (REPETF),HL                 ;e584  22 e8 e5    
    LD  HL,NEWBUF                       ;e587  21 25 eb    
    LD  D,0                             ;e58a  16 00       
    LD  C,9                             ;e58c  0e 09       
SETLP1: LD  B,8                         ;e58e  06 08       
    LD  A,(HL)                          ;e590  7e          
    CPL                                 ;e591  2f          
    OR  A                               ;e592  b7          
    JR  Z,SETPL3                        ;e593  28 09       
SETPL2: RRCA                            ;e595  0f          
    JP  C,KYBFST                        ;e596  da c6 e6    
    INC D                               ;e599  14          
    DJNZ    SETPL2                      ;e59a  10 f9       
    JR  SETPL4                          ;e59c  18 04       
SETPL3: LD  A,D                         ;e59e  7a          
    ADD A,8                             ;e59f  c6 08       
    LD  D,A                             ;e5a1  57          
SETPL4: INC HL                          ;e5a2  23          
    DEC C                               ;e5a3  0d          
    JR  NZ,SETLP1                       ;e5a4  20 e8       
KYBFSR: LD  HL,(POINT1)                 ;e5a6  2a 30 eb    
    LD  A,L                             ;e5a9  7d          
    CP  H                               ;e5aa  bc          
    JP  Z,ZEROR2                        ;e5ab  ca 5d e5    
    JP  BUFCEK                          ;e5ae  c3 25 e5    
                                        ;                  ;
FLASHS:                                 ;                  
                  ;	 CALL    ADRCAL                  ;
                  ;    SET 3,B                           
                  ;    LD  (FLASHA),BC                   
                  ;    IN  A,(C)                         
                  ;    LD  (FLASHD),A                    
                  ;    OR  1                             
                  ;    OUT (C),A                         
                  ;    LD  (FLASHO),A                    
                  ;    LD  A,(TICONT)                    
                  ;    LD  (FLASHC+1),A                 ;??+1"??ë¹ ì ¸?ˆì—ˆ??
    RET                                 ;e5b1  c9          ;
                                        ;                  ;
                                        ;                  ;
FLASHG: DEFB    001h                    ;e5b2  01          
FLASHA: DEFW    0                       ;e5b3  00 00       
    DEFB    03Eh                        ;e5b5  3e          ; LD A,
FLASHD: DEFB    000h                    ;e5b6  00          ;
                  ;    AND 0FEh                          
                  ;    LD  E,A                           
                  ;    LD  A,(TICONT)                    
FLASHC: SUB 0                           ;e5b7  d6 00       ; cursor blink time
    AND 010h                            ;e5b9  e6 10       
    LD  A,001h                          ;e5bb  3e 01       
    JR  Z,L0D28                         ;e5bd  28 01       
    XOR A                               ;e5bf  af          
L0D28:  OR  E                           ;e5c0  b3          
    DEFB    0FEh                        ;e5c1  fe          ;CP
FLASHO: DEFB    000h                    ;e5c2  00          
    RET Z                               ;e5c3  c8          
                  ;    OUT (C),A                         
                  ;    LD  (FLASHO),A                    
    RET                                 ;e5c4  c9          
                                        ;                  ;
FLASHE: LD  BC,(FLASHA)                 ;e5c5  ed 4b b3 e5 
    LD  A,(FLASHD)                      ;e5c9  3a b6 e5    
                  ;    OUT (C),A                         
    RET                                 ;e5cc  c9          
                                        ;                  ;
                                        ;                  ;
FLSHGT: PUSH    BC                      ;e5cd  c5          
    PUSH    DE                          ;e5ce  d5          
    PUSH    HL                          ;e5cf  e5          
    CALL    FLASHS                      ;e5d0  cd b1 e5    
FLGTLP: CALL    FLASHG                  ;e5d3  cd b2 e5    
    CALL    KEYSEN                      ;e5d6  cd 0b e6    
    JR  Z,FLSHL3                        ;e5d9  28 1b       
    CALL    NEWCEK                      ;e5db  cd 4c e6    
    LD  A,0                             ;e5de  3e 00       
    JR  NZ,FLSHRT                       ;e5e0  20 20       
    CALL    SAMECK                      ;e5e2  cd 62 e6    
    JR  NZ,FLGTLP                       ;e5e5  20 ec       
    DEFB    021h                        ;e5e7  21          ; LD HL,
REPETF: DEFW    00000h                  ;e5e8  00 00       ;
    DEC HL                              ;e5ea  2b          ;
    LD  (REPETF),HL                     ;e5eb  22 e8 e5    
    LD  A,H                             ;e5ee  7c          
    OR  L                               ;e5ef  b5          
    JR  NZ,FLGTLP                       ;e5f0  20 e1       
    LD  A,1                             ;e5f2  3e 01       
    JR  FLSHRT                          ;e5f4  18 0c       
FLSHL3: CALL    NEWFLG                  ;e5f6  cd 72 e6    
FLGTL2: CALL    FLASHG                  ;e5f9  cd b2 e5    
    CALL    KEYSEN                      ;e5fc  cd 0b e6    
    JR  Z,FLGTL2                        ;e5ff  28 f8       
    XOR A                               ;e601  af          
FLSHRT: PUSH    AF                      ;e602  f5          
    CALL    FLASHE                      ;e603  cd c5 e5    
    POP AF                              ;e606  f1          
    POP HL                              ;e607  e1          
    POP DE                              ;e608  d1          
    POP BC                              ;e609  c1          
    RET                                 ;e60a  c9          
                                        ;                  ;
                                        ;                  ;
                                        ;                  ;
KEYSEN: CALL    KEYSN2                  ;e60b  cd 1d e6    
KEYSN0: LD  B,4                         ;e60e  06 04       
KEYSN1: CALL    KEYSN2                  ;e610  cd 1d e6    
    BIT 1,E                             ;e613  cb 4b       
    JR  NZ,KEYSN0                       ;e615  20 f7       
    DJNZ    KEYSN1                      ;e617  10 f7       
    LD  A,E                             ;e619  7b          
    AND 1                               ;e61a  e6 01       
    RET                                 ;e61c  c9          
                                        ;                  ;
KEYSN2: LD  HL,NEWBUF                   ;e61d  21 25 eb    
    PUSH    BC                          ;e620  c5          
    LD  BC,08009h                       ;e621  01 09 80    ;KEYIO
    LD  DE,00900h                       ;e624  11 00 09    
KEYSN3: IN  A,(C)                       ;e627  ed 78       
    XOR (HL)                            ;e629  ae          
    JR  Z,L0D9D                         ;e62a  28 02       
    SET 1,E                             ;e62c  cb cb       
L0D9D:  XOR (HL)                        ;e62e  ae          
    LD  (HL),A                          ;e62f  77          
    CPL                                 ;e630  2f          
    OR  A                               ;e631  b7          
    JR  Z,L0DA5                         ;e632  28 02       
    SET 0,E                             ;e634  cb c3       
L0DA5:  INC HL                          ;e636  23          
    DEC BC                              ;e637  0b          
    DEC D                               ;e638  15          
    JR  NZ,KEYSN3                       ;e639  20 ec       
    IN  A,(C)                           ;e63b  ed 78       
    XOR (HL)                            ;e63d  ae          
    JR  Z,L0DB1                         ;e63e  28 02       
    SET 1,E                             ;e640  cb cb       
L0DB1:  XOR (HL)                        ;e642  ae          
    LD  (HL),A                          ;e643  77          
    AND 012h                            ;e644  e6 12       
    JR  NZ,L0DB9                        ;e646  20 02       
    SET 0,E                             ;e648  cb c3       
L0DB9:  POP BC                          ;e64a  c1          
    RET                                 ;e64b  c9          
                                        ;                  ;
NEWCEK: LD  HL,OLDBUF                   ;e64c  21 1b eb    
    LD  DE,NEWBUF                       ;e64f  11 25 eb    
    LD  B,9                             ;e652  06 09       
NEWPL1: LD  A,(DE)                      ;e654  1a          
    CPL                                 ;e655  2f          
    AND (HL)                            ;e656  a6          
    RET NZ                              ;e657  c0          
    INC DE                              ;e658  13          
    INC HL                              ;e659  23          
    DJNZ    NEWPL1                      ;e65a  10 f8       
    LD  A,(DE)                          ;e65c  1a          
    CPL                                 ;e65d  2f          
    AND (HL)                            ;e65e  a6          
    AND 010h                            ;e65f  e6 10       
    RET                                 ;e661  c9          
                                        ;                  ;
SAMECK: LD  HL,OLDBUF                   ;e662  21 1b eb    
    LD  DE,NEWBUF                       ;e665  11 25 eb    
    LD  B,10                            ;e668  06 0a       
SAMELP: LD  A,(DE)                      ;e66a  1a          
    XOR (HL)                            ;e66b  ae          
    RET NZ                              ;e66c  c0          
    INC DE                              ;e66d  13          
    INC HL                              ;e66e  23          
    DJNZ    SAMELP                      ;e66f  10 f9       
    RET                                 ;e671  c9          
                                        ;                  ;
NEWFLG: LD  HL,NEWBUF                   ;e672  21 25 eb    
    LD  DE,OLDBUF                       ;e675  11 1b eb    
    LD  B,9                             ;e678  06 09       
FLGLP1: LD  A,(DE)                      ;e67a  1a          
    CPL                                 ;e67b  2f          
    OR  (HL)                            ;e67c  b6          
    LD  C,(HL)                          ;e67d  4e          
    LD  (HL),A                          ;e67e  77          
    LD  A,C                             ;e67f  79          
    LD  (DE),A                          ;e680  12          
    INC DE                              ;e681  13          
    INC HL                              ;e682  23          
    DJNZ    FLGLP1                      ;e683  10 f5       
    LD  A,(HL)                          ;e685  7e          
    LD  (DE),A                          ;e686  12          
    LD  DE,NEWBUF                       ;e687  11 25 eb    
    LD  HL,OLDBUF                       ;e68a  21 1b eb    
    LD  BC,00900h                       ;e68d  01 00 09    
FLGLP2: LD  A,(DE)                      ;e690  1a          
    CPL                                 ;e691  2f          
    OR  A                               ;e692  b7          
    JR  Z,FLGLP3                        ;e693  28 0a       
    DEC C                               ;e695  0d          
    JR  NZ,FLGLP5                       ;e696  20 0c       
    OR  (HL)                            ;e698  b6          
    LD  (HL),A                          ;e699  77          
    LD  A,0FFh                          ;e69a  3e ff       
    LD  (DE),A                          ;e69c  12          
FLGLP4: LD  C,1                         ;e69d  0e 01       
FLGLP3: INC DE                          ;e69f  13          
    INC HL                              ;e6a0  23          
    DJNZ    FLGLP2                      ;e6a1  10 ed       
    RET                                 ;e6a3  c9          
FLGLP5: PUSH    BC                      ;e6a4  c5          
    LD  BC,00801h                       ;e6a5  01 01 08    
FLGLP6: RRCA                            ;e6a8  0f          
    JR  C,FLGLP7                        ;e6a9  38 0b       
    RLC C                               ;e6ab  cb 01       
    DJNZ    FLGLP6                      ;e6ad  10 f9       
    POP BC                              ;e6af  c1          
    JR  FLGLP4                          ;e6b0  18 eb       
FLGLP9: RRCA                            ;e6b2  0f          
    CALL    C,FLGLP8                    ;e6b3  dc bd e6    
FLGLP7: RLC C                           ;e6b6  cb 01       
    DJNZ    FLGLP9                      ;e6b8  10 f8       
    POP BC                              ;e6ba  c1          
    JR  FLGLP4                          ;e6bb  18 e0       
                                        ;                  ;
FLGLP8: PUSH    AF                      ;e6bd  f5          
    LD  A,C                             ;e6be  79          
    OR  (HL)                            ;e6bf  b6          
    LD  (HL),A                          ;e6c0  77          
    LD  A,(DE)                          ;e6c1  1a          
    OR  C                               ;e6c2  b1          
    LD  (DE),A                          ;e6c3  12          
    POP AF                              ;e6c4  f1          
    RET                                 ;e6c5  c9          
                                        ;                  ;
                                        ;                  ;
KYBFST: LD  A,(HL)                      ;e6c6  7e          
    LD  (KEYBFA),HL                     ;e6c7  22 74 e5    
    LD  (KEYBFD),A                      ;e6ca  32 77 e5    
    LD  C,D                             ;e6cd  4a          
    LD  B,0                             ;e6ce  06 00       
    LD  HL,KEYDT1                       ;e6d0  21 83 eb    ;NORMAL DATA
    LD  A,(NEWMOD)                      ;e6d3  3a 2e eb    
    BIT 1,A                             ;e6d6  cb 4f       
    JR  NZ,L0E4C                        ;e6d8  20 03       
    LD  HL,KEYDT2                       ;e6da  21 cb eb    ;SHIFT DATA
L0E4C:  ADD HL,BC                       ;e6dd  09          
    LD  C,(HL)                          ;e6de  4e          
    LD  B,A                             ;e6df  47          
    BIT 2,B                             ;e6e0  cb 50       
    JR  NZ,CTRLNO                       ;e6e2  20 09       
    LD  A,C                             ;e6e4  79          
    SUB 040h                            ;e6e5  d6 40       
    JR  C,NONKE?                        ;e6e7  38 17       
    AND 01Fh                            ;e6e9  e6 1f       
    JR  SETKY                           ;e6eb  18 0d       
CTRLNO: BIT 6,B                         ;e6ed  cb 70       
    JR  NZ,SETKY2                       ;e6ef  20 17       
    LD  A,C                             ;e6f1  79          
    SUB 040h                            ;e6f2  d6 40       
    JR  C,NONKEY                        ;e6f4  38 07       
    AND 01Fh                            ;e6f6  e6 1f       
    ADD A,080h                          ;e6f8  c6 80       
SETKY:  CALL    BFSTSB                  ;e6fa  cd 3e e7    
NONKEY: JP  KYBFSR                      ;e6fd  c3 a6 e5    
NONKE?: ADD A,010h                      ;e700  c6 10       
    CP  004h                            ;e702  fe 04       
    JR  NC,NONKEY                       ;e704  30 f7       
                  ;   LD  (COLORF),A                    
    JR  NONKEY                          ;e706  18 f5       
                                        ;                  ;
                                        ;                  ;
SETKY2: LD  A,C                         ;e708  79          
    CP  0F0h                            ;e709  fe f0       
    JR  NC,FUNCTN                       ;e70b  30 16       
    LD  A,(LOCKMD)                      ;e70d  3a 2f eb    
    OR  A                               ;e710  b7          
    LD  A,C                             ;e711  79          
    JR  Z,SETKY                         ;e712  28 e6       
    CP  041h                            ;e714  fe 41       
    JR  C,SETKY                         ;e716  38 e2       
    AND 01Fh                            ;e718  e6 1f       
    CP  01Bh                            ;e71a  fe 1b       
    LD  A,C                             ;e71c  79          
    JR  NC,SETKY                        ;e71d  30 db       
    XOR 020h                            ;e71f  ee 20       
    JR  SETKY                           ;e721  18 d7       
FUNCTN: SUB 0F1h                        ;e723  d6 f1       
    LD  L,A                             ;e725  6f          
    LD  H,0                             ;e726  26 00       
    ADD HL,HL                           ;e728  29          
    ADD HL,HL                           ;e729  29          
    ADD HL,HL                           ;e72a  29          
                  ;    ADD HL,HL                         
    LD  BC,FUNBUF                       ;e72b  01 32 eb    
    ADD HL,BC                           ;e72e  09          
    LD  B,(HL)                          ;e72f  46          
    INC HL                              ;e730  23          
    LD  A,B                             ;e731  78          
    OR  A                               ;e732  b7          
    JR  Z,NONKEY                        ;e733  28 c8       
FUNCLP: LD  A,(HL)                      ;e735  7e          
    CALL    BFSTSB                      ;e736  cd 3e e7    
    INC HL                              ;e739  23          
    DJNZ    FUNCLP                      ;e73a  10 f9       
    JR  NONKEY                          ;e73c  18 bf       
BFSTSB: PUSH    HL                      ;e73e  e5          
    PUSH    BC                          ;e73f  c5          
    LD  C,A                             ;e740  4f          
    LD  HL,(POINT1)                     ;e741  2a 30 eb    
    LD  A,H                             ;e744  7c          
    INC A                               ;e745  3c          
    AND 03Fh                            ;e746  e6 3f       
    CP  L                               ;e748  bd          
    JR  Z,NONSET                        ;e749  28 0c       
    LD  (POINT2),A                      ;e74b  32 31 eb    
    LD  L,A                             ;e74e  6f          
    LD  H,0                             ;e74f  26 00       
    LD  A,C                             ;e751  79          
    LD  BC,INKYBF                       ;e752  01 4d ef    
    ADD HL,BC                           ;e755  09          
    LD  (HL),A                          ;e756  77          
NONSET: POP BC                          ;e757  c1          
    POP HL                              ;e758  e1          
NORET:  RET                             ;e759  c9          
                  
                  
                  
CTL:                                    ;                  
    ld  hl,CTLTBL                       ;e75a  21 68 e7    
    add a,a                             ;e75d  87          
    add a,l                             ;e75e  85          
    ld  l,a                             ;e75f  6f          
    jr  nc,NOINC1                       ;e760  30 01       
    inc h                               ;e762  24          
NOINC1:                                 ;                  
    ld  e,(hl)                          ;e763  5e          
    inc hl                              ;e764  23          
    ld  d,(hl)                          ;e765  56          
    ex  de,hl                           ;e766  eb          
JPHL:                                   ;                  
    jp  (hl)                            ;e767  e9          
                  
CTLTBL:                                 ;                  
    dw  CTLNUL,CTLNUL,CTLNUL,CTLNUL,CTLNUL,CTLNUL,CTLNUL,CTLNUL;e768  76 e8 76 e8 
                                        ;e76c  76 e8 76 e8   1016   1031
                                        ;e770  76 e8 76 e8   1016   1032
                                        ;e774  76 e8 76 e8   1016   1033
    dw  CTLLFT,CTLRHT,CTLLF, CTLUP, CTLRHT,CTLCR, CTLNUL,CTLNUL;e778  3a e8 23 e8 
                                        ;e77c  ba e7 1a e8   1017   1035
                                        ;e780  23 e8 14 e8   1017   1036
                                        ;e784  76 e8 76 e8   1017   1037
    dw  CTLNUL,CTLNUL,CTLNUL,CTLNUL,CTLNUL,CTLNUL,CTLNUL,CTLNUL;e788  76 e8 76 e8 
                                        ;e78c  76 e8 76 e8   1018   1039
                                        ;e790  76 e8 76 e8   1018   1040
                                        ;e794  76 e8 76 e8   1018   1041
    dw  CTLNUL,CTLNUL,CTLCLS,CTLESC,CTLRHT,CTLLFT,CTLHOM,CTLNUL;e798  76 e8 76 e8 
                                        ;e79c  56 e8 71 e8   1019   1043
                                        ;e7a0  23 e8 3a e8   1019   1044
                                        ;e7a4  4e e8 76 e8   1019   1045
                                        ;                  
                                        ;                  
ACCPRT1:                                ;                  
    ld  a,(ESCMOD)                      ;e7a8  3a 0a eb    
    or  a                               ;e7ab  b7          
    jp  nz,ESC                          ;e7ac  c2 77 e8    
    ld  a,c                             ;e7af  79          
    and 7fh                             ;e7b0  e6 7f       ;reset bit7
    cp  20h                             ;e7b2  fe 20       
    jr  c,CTL                           ;e7b4  38 a4       
    call    COPYCHR                     ;e7b6  cd 02 e9    
    ret nz                              ;e7b9  c0          
                                        ;                  
CTLLF:                                  ;                  ;0ah(LF), line feed + carriage return
    ld  hl,CSRX                         ;e7ba  21 0d eb    
    ld  (hl),0                          ;e7bd  36 00       
    inc hl                              ;e7bf  23          
    inc (hl)                            ;e7c0  34          ;CSRY
    ld  a,(HEIGHT)                      ;e7c1  3a 15 eb    
    cp  (hl)                            ;e7c4  be          
    jr  nz,SETAD                        ;e7c5  20 34       
    dec (hl)                            ;e7c7  35          
    ld  de,VDISP                        ;e7c8  11 ad ef    
    ld  hl,VDISP+64                     ;e7cb  21 ed ef    
    ld  bc,64*(24-1)                    ;e7ce  01 c0 05    
                                        ;                  
    ldir                                ;e7d1  ed b0       
    ld  a,(WIDTH)                       ;e7d3  3a 14 eb    
    ld  b,a                             ;e7d6  47          
LOWEST:                                 ;                  
    ld  a," "                           ;e7d7  3e 20       
    ld  (de),a                          ;e7d9  12          
    inc de                              ;e7da  13          
    djnz    LOWEST                      ;e7db  10 fa       
                  
    ld  bc, VRAM+256                    ;e7dd  01 00 01    
    ld  de, 32*8*23                     ;e7e0  11 00 17    
    push de                             ;e7e3  d5          
MOVEN1:                                 ;                  
    in  a, (C)                          ;e7e4  ed 78       
    dec  b                              ;e7e6  05          
    out (c), a                          ;e7e7  ed 79       
    inc  b                              ;e7e9  04          
    inc  bc                             ;e7ea  03          
    dec  de                             ;e7eb  1b          
    ld  a,d                             ;e7ec  7a          
    or  e                               ;e7ed  b3          
    jr nz, MOVEN1                       ;e7ee  20 f4       
    ld  h,0                             ;e7f0  26 00       
    pop bc                              ;e7f2  c1          
MOVEN2:                                 ;                  
    xor a                               ;e7f3  af          
    out (c), a                          ;e7f4  ed 79       
    inc bc                              ;e7f6  03          
    dec h                               ;e7f7  25          
    or  h                               ;e7f8  b4          
    jr  nz, MOVEN2                      ;e7f9  20 f8       
                  
SETAD:                                  ;                  
                  ;set (CSRAD)
    ld  bc,(CSRX)                       ;e7fb  ed 4b 0d eb ;c=X,b=Y y*64
    ld  a,b                             ;e7ff  78          
    add a,a                             ;e800  87          ; Y*2
    add a,a                             ;e801  87          ; Y*4
    add a,a                             ;e802  87          ; Y*8
    ld  h,0                             ;e803  26 00       
    ld  l,a                             ;e805  6f          
    add hl,hl                           ;e806  29          ; Y*16
    add hl,hl                           ;e807  29          ; Y*32
    add hl,hl                           ;e808  29          ; Y*64
    ld  b,0                             ;e809  06 00       
    add hl,bc                           ;e80b  09          
    ld de,VDISP                         ;e80c  11 ad ef    
    add hl, de                          ;e80f  19          
    ld  (CSRAD),hl                      ;e810  22 0f eb    
    ret                                 ;e813  c9          
                  
CTLCR:                                  ;                  ;0dh(CR)
    xor a                               ;e814  af          
    ld  (CSRX),a                        ;e815  32 0d eb    
    jr  SETAD                           ;e818  18 e1       
                  
CTLUP:                                  ;                  ;0bh(VT)
    ld  hl,CSRY                         ;e81a  21 0e eb    
    ld  a,(hl)                          ;e81d  7e          
    or  a                               ;e81e  b7          
    ret z                               ;e81f  c8          
    dec (hl)                            ;e820  35          
    jr  SETAD                           ;e821  18 d8       
                  
CTLRHT:                                 ;                  ;09h(HT),0ch(FF),1ch(FS)
    ld  hl,CSRX                         ;e823  21 0d eb    
    ld  bc,(WIDTH)                      ;e826  ed 4b 14 eb 
    ld  a,(hl)                          ;e82a  7e          
    inc a                               ;e82b  3c          
    cp  c                               ;e82c  b9          
    jr  c,RHTOK                         ;e82d  38 08       
    inc hl                              ;e82f  23          ;CSRY
    ld  a,(hl)                          ;e830  7e          
    dec b                               ;e831  05          
    cp  b                               ;e832  b8          
    ret nc                              ;e833  d0          
    inc (hl)                            ;e834  34          
    dec hl                              ;e835  2b          ;CSRX
    xor a                               ;e836  af          
RHTOK:                                  ;                  
    ld  (hl),a                          ;e837  77          
    jr  SETAD                           ;e838  18 c1       
                                        ;                  
CTLLFT:                                 ;                  ;08h(BS),1dh(GS)
    ld  hl,CSRX                         ;e83a  21 0d eb    
    ld  a,(hl)                          ;e83d  7e          
    or  a                               ;e83e  b7          
    jr  nz,LFTOK                        ;e83f  20 09       
    inc hl                              ;e841  23          ;CSRY
    ld  a,(hl)                          ;e842  7e          
    or  a                               ;e843  b7          
    ret z                               ;e844  c8          
    dec (hl)                            ;e845  35          
    dec hl                              ;e846  2b          ;CSRX
    ld  a,(WIDTH)                       ;e847  3a 14 eb    
LFTOK:                                  ;                  
    dec a                               ;e84a  3d          
    ld  (hl),a                          ;e84b  77          
    jr  SETAD                           ;e84c  18 ad       
                  
CTLHOM:                                 ;                  ;1eh(RS)
    ld  hl,0                            ;e84e  21 00 00    
    ld  (CSRX),hl                       ;e851  22 0d eb    
    jr  SETAD                           ;e854  18 a5       
                  
CTLCLS:                                 ;                  ;1ah(SUB)
    ld  hl,VDISP                        ;e856  21 ad ef    
    ld  de,VDISP+1                      ;e859  11 ae ef    
    ld  bc,64*24-1                      ;e85c  01 c0 05    
    ld  (hl)," "                        ;e85f  36 20       
    ldir                                ;e861  ed b0       
                  
    ld bc, 32 * 192                     ;e863  01 00 18    
    ld l, 0                             ;e866  2e 00       
LOOP1:                                  ;                  
    out (c), l                          ;e868  ed 69       
    DEC BC                              ;e86a  0b          
    LD A, B                             ;e86b  78          
    OR C                                ;e86c  b1          
    JR NZ, LOOP1                        ;e86d  20 f9       
                                        ;                  
    jr  CTLHOM                          ;e86f  18 dd       ;?
                  
CTLESC:                                 ;                  ;1bh(ESC)
    ld  a,1                             ;e871  3e 01       
    ld  (ESCMOD),a                      ;e873  32 0a eb    
CTLNUL:                                 ;                  ;00h(NUL),etc.
    ret                                 ;e876  c9          
                  
ESC:                                    ;                  
    dec a                               ;e877  3d          ;a=(ESCMOD)
    jr  z,ESC1                          ;e878  28 30       
    dec a                               ;e87a  3d          
    jr  z,ESC2                          ;e87b  28 23       
                  
ESC3:                                   ;                  
    xor a                               ;e87d  af          
    ld  (ESCMOD),a                      ;e87e  32 0a eb    
    ld  a,c                             ;e881  79          
    sub 20h                             ;e882  d6 20       
    ld  bc,(WIDTH)                      ;e884  ed 4b 14 eb 
    cp  c                               ;e888  b9          
    jr  c,XOK                           ;e889  38 02       
    ld  a,c                             ;e88b  79          
    dec a                               ;e88c  3d          
XOK:                                    ;                  
    ld  (CSRX),a                        ;e88d  32 0d eb    
    ld  a,(ESCEQY)                      ;e890  3a 0b eb    
    sub 20h                             ;e893  d6 20       
    cp  b                               ;e895  b8          
    jr  c,YOK                           ;e896  38 02       
    ld  a,b                             ;e898  78          
    dec a                               ;e899  3d          
YOK:                                    ;                  
    ld  (CSRY),a                        ;e89a  32 0e eb    
    jp  SETAD                           ;e89d  c3 fb e7    
                  
ESC2:                                   ;                  
    ld  a,3                             ;e8a0  3e 03       
    ld  (ESCMOD),a                      ;e8a2  32 0a eb    
    ld  a,c                             ;e8a5  79          
    ld  (ESCEQY),a                      ;e8a6  32 0b eb    
    ret                                 ;e8a9  c9          
                  
ESC1:                                   ;                  
    ld  (ESCMOD),a                      ;e8aa  32 0a eb    ;a=0
    ld  a,c                             ;e8ad  79          
    cp  "="                             ;e8ae  fe 3d       
    jr  z,ESCEQ                         ;e8b0  28 0d       
    cp  "T"                             ;e8b2  fe 54       
    jr  z,ESCT                          ;e8b4  28 0f       
    cp  "Y"                             ;e8b6  fe 59       
    jr  z,ESCY                          ;e8b8  28 21       
    cp  "*"                             ;e8ba  fe 2a       
    jr  z,CTLCLS                        ;e8bc  28 98       
    ret                                 ;e8be  c9          
                  
ESCEQ:                                  ;                  ;set cursor (ESC=YX)
    ld  a,2                             ;e8bf  3e 02       
    ld  (ESCMOD),a                      ;e8c1  32 0a eb    
    ret                                 ;e8c4  c9          
                  
ESCT:                                   ;                  ;clear to line end
    ld  hl,(CSRX)                       ;e8c5  2a 0d eb    
    push    hl                          ;e8c8  e5          
    call    ESCTLP                      ;e8c9  cd d3 e8    
    pop hl                              ;e8cc  e1          
    ld  (CSRX),hl                       ;e8cd  22 0d eb    
    jp  SETAD                           ;e8d0  c3 fb e7    
                  
ESCTLP:                                 ;                  
    ld  a," "                           ;e8d3  3e 20       
    call    COPYCHR                     ;e8d5  cd 02 e9    
    jr  nz,ESCTLP                       ;e8d8  20 f9       
    ret                                 ;e8da  c9          
                  
ESCY:                                   ;                  ;clear to screen end
    ld  hl,(CSRX)                       ;e8db  2a 0d eb    
    push    hl                          ;e8de  e5          
ESCYLP:                                 ;                  
    call    ESCTLP                      ;e8df  cd d3 e8    
    ld  hl,CSRX                         ;e8e2  21 0d eb    
    ld  (hl),0                          ;e8e5  36 00       
    inc hl                              ;e8e7  23          
    inc (hl)                            ;e8e8  34          
    ld  a,(hl)                          ;e8e9  7e          
    cp  24                              ;e8ea  fe 18       
    jr  c,ESCYLP                        ;e8ec  38 f1       
    pop hl                              ;e8ee  e1          
    ld  (CSRX),hl                       ;e8ef  22 0d eb    
    ret                                 ;e8f2  c9          
                  
CALCAD:                                 ;                  ; af,bc,hl
                  ;calculate VRAM address
    xor a                               ;e8f3  af          
    ld  l,a                             ;e8f4  6f          
    ld  a,(CSRY)                        ;e8f5  3a 0e eb    
    ld  h,a                             ;e8f8  67          ;Y*256
    ld  b,VRAM/256                      ;e8f9  06 00       
    ld  a,(CSRX)                        ;e8fb  3a 0d eb    
    rra                                 ;e8fe  1f          ;X/2
    ld  c,a                             ;e8ff  4f          
    add hl,bc                           ;e900  09          ;VRAM+Y*256+X/2
    ret                                 ;e901  c9          
                  
COPYCHR:                                ;                  ;return z-flag=1 if cursor reach line end
    ld  hl,(CSRAD)                      ;e902  2a 0f eb    
    cp  (hl)                            ;e905  be          
    jr  z,INCCSR                        ;e906  28 71       
    ld  (hl),a                          ;e908  77          
    add a,a                             ;e909  87          
    ld  h,0                             ;e90a  26 00       
    ld  l,a                             ;e90c  6f          
    add hl,hl                           ;e90d  29          
    ld  de,FONT-80h                     ;e90e  11 09 e9    
    add hl,de                           ;e911  19          
    ex  de,hl                           ;e912  eb          
                  ;	call	CALCAD		;de no change
    xor a                               ;e913  af          
    ld  a,(CSRY)                        ;e914  3a 0e eb    
    ld  h, a                            ;e917  67          
    ld  a,(CSRX)                        ;e918  3a 0d eb    
    rra                                 ;e91b  1f          
    ld  l,a                             ;e91c  6f          
    ld  b,4                             ;e91d  06 04       
    jr  c,XODD                          ;e91f  38 2d       
                  
XEVEN:                                  ;                  
                  ;x=0,2,4,...
    push bc                             ;e921  c5          
    ld  b,h                             ;e922  44          
    ld  c,l                             ;e923  4d          
    in  a, (c)                          ;e924  ed 78       
    ld  c, a                            ;e926  4f          
    ld  a,(de)                          ;e927  1a          ;font
    xor c                               ;e928  a9          
    and 0f0h                            ;e929  e6 f0       
    xor c                               ;e92b  a9          
    ld  c,l                             ;e92c  4d          
    out (c), a                          ;e92d  ed 79       
    ld  bc, 32                          ;e92f  01 20 00    
    add hl, bc                          ;e932  09          
    ld  b,h                             ;e933  44          
    ld  c,l                             ;e934  4d          
    in  a, (c)                          ;e935  ed 78       
    ld  c, a                            ;e937  4f          
    ld  a,(de)                          ;e938  1a          ;font
    rlca                                ;e939  07          
    rlca                                ;e93a  07          
    rlca                                ;e93b  07          
    rlca                                ;e93c  07          
    xor c                               ;e93d  a9          
    and 0f0h                            ;e93e  e6 f0       
    xor  c                              ;e940  a9          
    ld  c,l                             ;e941  4d          
    out (c), a                          ;e942  ed 79       
    ld  bc, 32                          ;e944  01 20 00    
    add hl, bc                          ;e947  09          
    inc de                              ;e948  13          
    pop bc                              ;e949  c1          
    djnz    XEVEN                       ;e94a  10 d5       
    jr  INCCSR                          ;e94c  18 2b       
                  
XODD:                                   ;                  
                  ;x=1,3,5,...
    push bc                             ;e94e  c5          
    ld  b, h                            ;e94f  44          
    ld  c, l                            ;e950  4d          
    in  a, (c)                          ;e951  ed 78       
    ld  c, a                            ;e953  4f          
    ld  a,(de)                          ;e954  1a          ;font
    rrca                                ;e955  0f          
    rrca                                ;e956  0f          
    rrca                                ;e957  0f          
    rrca                                ;e958  0f          
    xor c                               ;e959  a9          
    and 0fh                             ;e95a  e6 0f       
    xor c                               ;e95c  a9          
    ld  c, l                            ;e95d  4d          
    out (c), a                          ;e95e  ed 79       
    ld  bc, 32                          ;e960  01 20 00    
    add hl, bc                          ;e963  09          
    ld  b, h                            ;e964  44          
    ld  c, l                            ;e965  4d          
    in  a, (c)                          ;e966  ed 78       
    ld  c, a                            ;e968  4f          
    ld  a,(de)                          ;e969  1a          ;font
    xor c                               ;e96a  a9          
    and 0fh                             ;e96b  e6 0f       
    xor c                               ;e96d  a9          
    ld  c, l                            ;e96e  4d          
    out (c), a                          ;e96f  ed 79       
    ld  bc, 32                          ;e971  01 20 00    
    add hl, bc                          ;e974  09          
    inc de                              ;e975  13          
    pop bc                              ;e976  c1          
    djnz    XODD                        ;e977  10 d5       
                  
INCCSR:                                 ;                  
    ld  hl,(CSRAD)                      ;e979  2a 0f eb    
    inc hl                              ;e97c  23          
    ld  (CSRAD),hl                      ;e97d  22 0f eb    
    ld  hl,CSRX                         ;e980  21 0d eb    
    inc (hl)                            ;e983  34          
    ld  a,(WIDTH)                       ;e984  3a 14 eb    
    cp  (hl)                            ;e987  be          
    ret                                 ;e988  c9          
                                        ;                  
FONT:                                   ;                  
    db  000h,000h,000h,000h             ;e989  00 00 00 00 ;sp
    db  044h,044h,040h,040h             ;e98d  44 44 40 40 ;!
    db  0aah,000h,000h,000h             ;e991  aa 00 00 00 ;"
    db  00ah,0eah,0eah,000h             ;e995  0a ea ea 00 ;#
    db  04eh,0ceh,06eh,040h             ;e999  4e ce 6e 40 ;$
    db  008h,024h,082h,000h             ;e99d  08 24 82 00 ;%
    db  04ah,0a4h,0a8h,060h             ;e9a1  4a a4 a8 60 ;&
    db  048h,000h,000h,000h             ;e9a5  48 00 00 00 ;'
    db  024h,044h,044h,020h             ;e9a9  24 44 44 20 ;(
    db  084h,044h,044h,080h             ;e9ad  84 44 44 80 ;)
    db  004h,0e4h,0e4h,000h             ;e9b1  04 e4 e4 00 ;*
    db  004h,04eh,044h,000h             ;e9b5  04 4e 44 00 ;+
    db  000h,000h,044h,080h             ;e9b9  00 00 44 80 ;,
    db  000h,00eh,000h,000h             ;e9bd  00 0e 00 00 ;-
    db  000h,000h,000h,040h             ;e9c1  00 00 00 40 ;.
    db  022h,044h,048h,080h             ;e9c5  22 44 48 80 ;/
                  
    db  04ah,0aeh,0aah,040h             ;e9c9  4a ae aa 40 ;0
    db  04ch,044h,044h,0e0h             ;e9cd  4c 44 44 e0 ;1
    db  04ah,0a2h,048h,0e0h             ;e9d1  4a a2 48 e0 ;2
    db  04ah,024h,02ah,040h             ;e9d5  4a 24 2a 40 ;3
    db  026h,0aah,0e2h,020h             ;e9d9  26 aa e2 20 ;4
    db  0e8h,08ch,022h,0c0h             ;e9dd  e8 8c 22 c0 ;5
    db  04ah,08ch,0aah,040h             ;e9e1  4a 8c aa 40 ;6
    db  0eah,022h,044h,040h             ;e9e5  ea 22 44 40 ;7
    db  04ah,0a4h,0aah,040h             ;e9e9  4a a4 aa 40 ;8
    db  04ah,0a6h,02ah,040h             ;e9ed  4a a6 2a 40 ;9
    db  004h,040h,044h,000h             ;e9f1  04 40 44 00 ;:
    db  004h,040h,044h,080h             ;e9f5  04 40 44 80 ;;
    db  002h,048h,042h,000h             ;e9f9  02 48 42 00 ;<
    db  000h,0e0h,0e0h,000h             ;e9fd  00 e0 e0 00 ;=
    db  008h,042h,048h,000h             ;ea01  08 42 48 00 ;>
    db  04ah,024h,040h,040h             ;ea05  4a 24 40 40 ;?
                  
    db  04ah,022h,06ah,040h             ;ea09  4a 22 6a 40 ;@
    db  04ah,0aeh,0aah,0a0h             ;ea0d  4a ae aa a0 ;A
    db  0cah,0ach,0aah,0c0h             ;ea11  ca ac aa c0 ;B
    db  04ah,088h,08ah,040h             ;ea15  4a 88 8a 40 ;C
    db  0cah,0aah,0aah,0c0h             ;ea19  ca aa aa c0 ;D
    db  0e8h,08eh,088h,0e0h             ;ea1d  e8 8e 88 e0 ;E
    db  0e8h,08eh,088h,080h             ;ea21  e8 8e 88 80 ;F
    db  068h,08eh,0aah,040h             ;ea25  68 8e aa 40 ;G
    db  0aah,0aeh,0aah,0a0h             ;ea29  aa ae aa a0 ;H
    db  0e4h,044h,044h,0e0h             ;ea2d  e4 44 44 e0 ;I
    db  0e4h,044h,044h,080h             ;ea31  e4 44 44 80 ;J
    db  0aah,0cch,0aah,0a0h             ;ea35  aa cc aa a0 ;K
    db  088h,088h,088h,0e0h             ;ea39  88 88 88 e0 ;L
    db  0aeh,0eeh,0aah,0a0h             ;ea3d  ae ee aa a0 ;M
    db  0aeh,0eeh,0eeh,0a0h             ;ea41  ae ee ee a0 ;N
    db  04ah,0aah,0aah,040h             ;ea45  4a aa aa 40 ;O
                  
    db  0cah,0ach,088h,080h             ;ea49  ca ac 88 80 ;P
    db  04ah,0aah,0a4h,020h             ;ea4d  4a aa a4 20 ;Q
    db  0cah,0ach,0aah,0a0h             ;ea51  ca ac aa a0 ;R
    db  04ah,084h,02ah,040h             ;ea55  4a 84 2a 40 ;S
    db  0e4h,044h,044h,040h             ;ea59  e4 44 44 40 ;T
    db  0aah,0aah,0aah,0e0h             ;ea5d  aa aa aa e0 ;U
    db  0aah,0aah,0aah,040h             ;ea61  aa aa aa 40 ;V
    db  0aah,0eeh,0eeh,0a0h             ;ea65  aa ee ee a0 ;W
    db  0aah,0a4h,0aah,0a0h             ;ea69  aa a4 aa a0 ;X
    db  0aah,0a4h,044h,040h             ;ea6d  aa a4 44 40 ;Y
    db  0e2h,0a4h,0a8h,0e0h             ;ea71  e2 a4 a8 e0 ;Z
    db  064h,044h,044h,060h             ;ea75  64 44 44 60 ;[
    db  0aah,04eh,04eh,040h             ;ea79  aa 4e 4e 40 ;\
    db  0c4h,044h,044h,0c0h             ;ea7d  c4 44 44 c0 ;]
    db  04ah,000h,000h,000h             ;ea81  4a 00 00 00 ;^
    db  000h,000h,000h,0e0h             ;ea85  00 00 00 e0 ;_
                  
    db  042h,000h,000h,000h             ;ea89  42 00 00 00 ;`
    db  000h,0c2h,0eah,0e0h             ;ea8d  00 c2 ea e0 ;a
    db  088h,08ch,0aah,0c0h             ;ea91  88 8c aa c0 ;b
    db  000h,068h,088h,060h             ;ea95  00 68 88 60 ;c
    db  022h,026h,0aah,060h             ;ea99  22 26 aa 60 ;d
    db  000h,04ah,0e8h,060h             ;ea9d  00 4a e8 60 ;e
    db  024h,04eh,044h,040h             ;eaa1  24 4e 44 40 ;f
    db  000h,06ah,062h,0c0h             ;eaa5  00 6a 62 c0 ;g
    db  088h,08ch,0aah,0a0h             ;eaa9  88 8c aa a0 ;h
    db  040h,044h,044h,040h             ;eaad  40 44 44 40 ;i
    db  020h,022h,02ah,040h             ;eab1  20 22 2a 40 ;j
    db  088h,0ach,0cah,0a0h             ;eab5  88 ac ca a0 ;k
    db  044h,044h,044h,060h             ;eab9  44 44 44 60 ;l
    db  000h,0eeh,0eeh,0a0h             ;eabd  00 ee ee a0 ;m
    db  000h,0cah,0aah,0a0h             ;eac1  00 ca aa a0 ;n
    db  000h,04ah,0aah,040h             ;eac5  00 4a aa 40 ;o
                  
    db  000h,0cah,0c8h,080h             ;eac9  00 ca c8 80 ;p
    db  000h,06ah,062h,020h             ;eacd  00 6a 62 20 ;q
    db  000h,0ach,088h,080h             ;ead1  00 ac 88 80 ;r
    db  000h,068h,042h,0c0h             ;ead5  00 68 42 c0 ;s
    db  004h,0e4h,044h,060h             ;ead9  04 e4 44 60 ;t
    db  000h,0aah,0aah,060h             ;eadd  00 aa aa 60 ;u
    db  000h,0aah,0aah,040h             ;eae1  00 aa aa 40 ;v
    db  000h,0aah,0eeh,0a0h             ;eae5  00 aa ee a0 ;w
    db  000h,0aah,04ah,0a0h             ;eae9  00 aa 4a a0 ;x
    db  000h,0aah,062h,0c0h             ;eaed  00 aa 62 c0 ;y
    db  000h,0e2h,048h,0e0h             ;eaf1  00 e2 48 e0 ;z
    db  024h,048h,044h,020h             ;eaf5  24 48 44 20 ;{
    db  044h,040h,044h,040h             ;eaf9  44 40 44 40 ;|
    db  084h,042h,044h,080h             ;eafd  84 42 44 80 ;}
    db  000h,02eh,080h,000h             ;eb01  00 2e 80 00 ;~
    db  000h,000h,000h,000h             ;eb05  00 00 00 00 ;none
                  
                                        ;                  
                  ;
                  ;
                  ; Workarea for SPC-1000
                  ;
CAPS:   db  0                           ;eb09  00          ;caps lock, non-zero=on
ESCMOD: db  0                           ;eb0a  00          ;waiting for ESC character
ESCEQY: db  0                           ;eb0b  00          ;
TIME:   db  0                           ;eb0c  00          ;2ms timer
                  
CSRX:   db  0                           ;eb0d  00          ;cursor x position on virtual display
CSRY:   db  0                           ;eb0e  00          ;cursor y positin on virtual display
CSRAD:  dw  VDISP                       ;eb0f  ad ef       ;cursor address on virtual display
CSRATT: dw  0                           ;eb11  00 00       ;cursor attribute address on real display
                                        ;                  ; used and changed by only CONIN and INTGAM
CSROUT: db  0                           ;eb13  00          ;cursor in/out of real display (non-zero=out)
                  
                                        ;                  ;BIOS work area
WIDTH:  db  64                          ;eb14  40          ;virtual display size=80x25
HEIGHT: db  24                          ;eb15  18          ;
    ds  1                               ;eb16              
VDAREA: db  0                           ;eb17  00          ;display area number in virtual display
                  
VRAM    equ 0h                          ;0000              ;VRAM plane1
                  ;ATTR	equ	0e000h		;VRAM plane2
                                        ;                  
                  
                  
GMODEF: DEFB    0                       ;eb18  00          
CURX:   DEFB    0                       ;eb19  00          ;11ed  00            2867   2874 ; cursor X
CURY:   DEFB    0                       ;eb1a  00          ;11ee  00            2868   2875 ; cursor Y
OLDBUF: DEFS    10                      ;eb1b              ;11ef                2869   2876 ; keyboard matrix old buffer
NEWBUF: DEFS    9                       ;eb25              ;11f9                2870   2877 ; keyboard matrix new buffer
NEWMOD: DEFB    0FFh                    ;eb2e  ff          ;1202  ff            2871   2878 ; keyboard matrix mode flag
                                        ;                  ;                    2872   2879 ;
LOCKMD: DEFB    0                       ;eb2f  00          ;1203  00            2873   2880 ; LOCK mode
POINT1: DEFB    0                       ;eb30  00          ;1204  00            2874   2881 ; key input buffer 
POINT2: DEFB    0                       ;eb31  00          ;1205  00            2875   2882 ; key input buffer 
                                        ;                  ;                    2878   2885 ;
                                        ;                  ;                    2879   2886 ;
FUNS    EQU  8                                      ;0008              
FUNBUF:                                 ;                  
    DEFB    4                           ;eb32  04          
    DEFM    'DIR'                       ;eb33  44 49 52    
    DEFB    00Dh                        ;eb36  0d          
    DEFS    11-FUNS                     ;eb37              
                                        ;                  
    DEFB    4                           ;eb3a  04          
    DEFM    'ERA '                      ;eb3b  45 52 41 20 
    DEFB    0                           ;eb3f  00          
    DEFS    10-FUNS                     ;eb40              
                                        ;                  
                  
    DEFB    4                           ;eb42  04          
    DEFM    'REN '                      ;eb43  52 45 4e 20 
    DEFB    0                           ;eb47  00          
    DEFS    10-FUNS                     ;eb48              
                  
    DEFB    5                           ;eb4a  05          
    DEFM    'SAVE '                     ;eb4b  53 41 56 45 
                                        ;eb4f  20            1536   1563
    DEFB    0                           ;eb50  00          
    DEFS    9-FUNS                      ;eb51              
                  
    DEFB    5                           ;eb52  05          
    DEFM    'TYPE '                     ;eb53  54 59 50 45 
                                        ;eb57  20            1541   1569
    DEFB    0                           ;eb58  00          
    DEFS    9-FUNS                      ;eb59              
                  
    DEFB    4                           ;eb5a  04          
    DEFM    'PIP '                      ;eb5b  50 49 50 20 
    DEFB    0                           ;eb5f  00          
    DEFS    10-FUNS                     ;eb60              
                  
    DEFB    4                           ;eb62  04          
    DEFM    'STAT '                     ;eb63  53 54 41 54 
                                        ;eb67  20            1551   1580
    DEFB    0                           ;eb68  00          
    DEFS    10-FUNS                     ;eb69              
                  
    DEFB    3                           ;eb6b  03          
    DEFM    'ED '                       ;eb6c  45 44 20    
    DEFB    0                           ;eb6f  00          
    DEFS    11-FUNS                     ;eb70              
                  
    DEFB    4                           ;eb73  04          
    DEFM    'ASM '                      ;eb74  41 53 4d 20 
    DEFB    0                           ;eb78  00          
    DEFS    10-FUNS                     ;eb79              
                  
    DEFB    4                           ;eb7b  04          
    DEFM    'DDT '                      ;eb7c  44 44 54 20 
    DEFB    0                           ;eb80  00          
    DEFS    10-FUNS                     ;eb81              
                                        ;                  ;
KEYDT1: DEFW    0F500h                  ;eb83  00 f5       ;8009  No Shift
    DEFM    '-0                         ;eb85  2d 30 3b    ;'                      ;'		;'
    DEFW    06F6Ch                      ;eb88  6c 6f       ;LO
    DEFM    '9'                         ;eb8a  39          ;9
    DEFW    0F400h                      ;eb8b  00 f4       ;8008
    DEFB    01Fh                        ;eb8d  1f          
    DEFM    ':/'                        ;eb8e  3a 2f       ;/
    DEFW    0696Bh                      ;eb90  6b 69       ;KI
    DEFM    '8'                         ;eb92  38          
    DEFW    0F300h                      ;eb93  00 f3       ;8007
    DEFW    0701Eh                      ;eb95  1e 70       ;P
    DEFM    '.'                         ;eb97  2e          ;
    DEFW    0756Ah                      ;eb98  6a 75       ;JU
    DEFM    '7'                         ;eb9a  37          
    DEFW    0F200h                      ;eb9b  00 f2       ;8006
    DEFW    07840h                      ;eb9d  40 78       ;X
    DEFM    ','                         ;eb9f  2c          
    DEFW    07968h                      ;eba0  68 79       ;HV
    DEFM    '6'                         ;eba2  36          
    DEFW    0F100h                      ;eba3  00 f1       ;8005
    DEFW    05D1Dh                      ;eba5  1d 5d       
    DEFW    0676Dh                      ;eba7  6d 67       ;MG
    DEFW    03574h                      ;eba9  74 35       ;T5
    DEFW    00000h                      ;ebab  00 00       ;8004
    DEFW    07C1Ch                      ;ebad  1c 7c       
    DEFW    0666Eh                      ;ebaf  6e 66       ;NF
    DEFW    03472h                      ;ebb1  72 34       ;R4
    DEFW    00008h                      ;ebb3  08 00       ;DEL ;8003
    DEFW    05B1Bh                      ;ebb5  1b 5b       
    DEFW    06462h                      ;ebb7  62 64       ;BD
    DEFW    03365h                      ;ebb9  65 33       ;E3
    DEFW    00016h                      ;ebbb  16 00       ;LOCK ;8002
    DEFW    05D7Ah                      ;ebbd  7a 5d       ;Z^
    DEFW    07376h                      ;ebbf  76 73       ;VS
    DEFW    03277h                      ;ebc1  77 32       ;W2
    DEFW    00B5Eh                      ;ebc3  5e 0b       ;HOME ;8001
    DEFW    00D20h                      ;ebc5  20 0d       
    DEFW    06163h                      ;ebc7  63 61       ;CA
    DEFW    03171h                      ;ebc9  71 31       ;Q1
                                        ;                  ;
                                        ;                  ;
                                        ;                  ;
KEYDT2: DEFW    0FA00h                  ;ebcb  00 fa       ; Shift
    DEFM    '=0+LO)'                    ;ebcd  3d 30 2b 4c 
                                        ;ebd1  4f 29         1613   1643
    DEFW    0F900h                      ;ebd3  00 f9       
    DEFB    01Fh                        ;ebd5  1f          
    DEFM    '*?KI('                     ;ebd6  2a 3f 4b 49 
                                        ;ebda  28            1616   1647
    DEFW    0F800h                      ;ebdb  00 f8       
    DEFB    01Eh                        ;ebdd  1e          
    DEFM    'P>JU'                      ;ebde  50 3e 4a 55 
    DEFB    027h                        ;ebe2  27          
    DEFW    0F700h                      ;ebe3  00 f7       
    DEFB    060h                        ;ebe5  60          
    DEFM    'X<HY&'                     ;ebe6  58 3c 48 59 
                                        ;ebea  26            1623   1655
    DEFW    0F600h                      ;ebeb  00 f6       
    DEFW    07D1Dh                      ;ebed  1d 7d       
    DEFM    'MGT%'                      ;ebef  4d 47 54 25 
    DEFW    00000h                      ;ebf3  00 00       
    DEFW    07F1Ch                      ;ebf5  1c 7f       
    DEFM    'NFR$'                      ;ebf7  4e 46 52 24 
    DEFW    00012h                      ;ebfb  12 00       ;INST
    DEFW    07B1Bh                      ;ebfd  1b 7b       
    DEFM    'BDE#'                      ;ebff  42 44 45 23 
    DEFW    00017h                      ;ec03  17 00       ;LOCK
    DEFM    'Z'                         ;ec05  5a          
    DEFB    07Dh                        ;ec06  7d          
    DEFM    'VSW"'                      ;ec07  56 53 57 22 
    DEFW    00C7Eh                      ;ec0b  7e 0c       ;CLR
    DEFW    00D20h                      ;ec0d  20 0d       
    DEFM    'CAQ!'                      ;ec0f  43 41 51 21 
    REF                                 ;                  ;of BIOS
                  
                  ;
                  ;	the remainder of the CBIOS is reserved uninitialized
                  ;	data area, and does not need to be a part of the
                  ;	system memory image (the space must be available,
                  ;	however, between "begdat" and "enddat").
                  ;
                  ;	scratch ram area for BDOS use
                  ;
BEGDAT  EQU $                           ;ec13              ;beginning of data area
DIRBF:  DEFS    128                     ;ec13              ;scratch directory area
ALL00:  DEFS    31                      ;ec93              ;allocation vector 0
ALL01:  DEFS    31                      ;ecb2              ;allocation vector 1
ALL02:  DEFS    31                      ;ecd1              ;allocation vector 2
ALL03:  DEFS    31                      ;ecf0              ;allocation vector 3
ALLHD1: DEFS    255                     ;ed0f              ;allocation vector harddisk 1
ALLHD2: DEFS    255                     ;ee0e              ;allocation vector harddisk 2
CHK00:  DEFS    16                      ;ef0d              ;check vector 0
CHK01:  DEFS    16                      ;ef1d              ;check vector 1
CHK02:  DEFS    16                      ;ef2d              ;check vector 2
CHK03:  DEFS    16                      ;ef3d              ;check vector 3
CHKHD1: DEFS    0                       ;ef4d              ;check vector harddisk 1
CHKHD2: DEFS    0                       ;ef4d              ;check vector harddisk 2
                  ;KEYBUF: DEFS    40h
INKYBF: DEFS    040h                    ;ef4d              ;1206                2876   2883 ; key input buffer
TABBUF: DEFS    32                      ;ef8d              ;1246                2877   2884 ; TAB flag
VDISP:  defs 64*24                      ;efad              ;virtual display address
DISKDATA: DEFS  256                     ;f5ad              
                  ;
ENDDAT  EQU $                           ;f6ad              ;end of data area
DATSIZ  EQU $-BEGDAT                    ;0a9a              ;size of data area
                  ;
                  
;Z80-Assembler		Release 1.6				Page 1
;Source file: spc-1000_cpm_bios.asm
;Title:       Symboltable

VRAM     0000	SDINIT   0000	CONSTA   0000	CONDAT   0001	
SDWRITE  0001	PRTSTA   0002	SDREAD   0002	PRTDAT   0003	
SDSEND   0003	IOBYTE   0003	SDCOPY   0004	CDISK    0004	
SDFORMAT 0005	AUXDAT   0005	SDSTATUS 0006	SDDRVSTS 0007	
SDRAMTST 0008	FUNS     0008	SDTRANS2 0009	FDCD     000a	
SDNOACT  000a	SDTRANS1 000b	FDCT     000b	SDRCVE   000c	
FDCS     000c	SDGO     000d	FDCOP    000d	FDCST    000e	
SDLOAD   000e	SDSAVE   000f	DMAL     000f	SDLDNGO  0010	
DMAH     0010	NSECTS   002c	MSIZE    003a	DATSIZ   0a9a	
KEYBUF   7a4f	BIAS     9800	CCP      cc00	BDOS     d406	
BIOS     e200	WBOOTE   e203	DPBASE   e233	TRANS    e253	
DPBLK    e26d	SIGNON   e27c	LDERR    e2af	PRTMSG   e2c5	
BOOT     e2d0	CLS3     e2e1	WBOOT    e2f9	LOAD1    e30d	
LOAD2    e328	GOCPM    e343	CONST    e364	CONIN    e36c	
CONOUT   e370	ASCPRT   e371	LIST     e377	LISTST   e379	
PUNCHS   e37c	READER   e37e	HOME     e37f	SELDSK   e384	
SELFD    e38d	SELFD$   e399	SETTRK   e3a8	SETSEC   e3b7	
SETSEC0  e3ca	SECTRAN  e3cf	SECT1    e3da	SETDMA   e3e0	
READ     e3e5	BUFCHECK e3ec	REALREAD e3f2	SYM1     e41d	
BUFCOPY  e427	ODDREAD  e42f	EVENREAD e430	WRITE    e43b	
WRITEC   e43b	ODDWRIT  e448	EVENWRIT e449	CHKWCPY  e450	
CHKWFLG  e450	WRITEM   e450	READ1    e47d	WAITIO   e4a5	
SENDCOM  e4a6	SENDDAT  e4ae	CHKRFD1  e4b2	CHKDAC2  e4c9	
CHKDAC3  e4d6	GETDATA  e4dd	CHKDAV0  e4e8	CHKDAV1  e4ff	
FDD#N    e50c	FDD#D    e50d	FDD#T    e50e	FDD#S    e50f	
DATADDR  e510	CHGFLG   e512	PRESEC   e513	BRKEY    e514	
ASCGET1  e51b	BUFCEK   e525	GETRET   e533	BUFSET   e537	
FLASHF   e538	BRKGTR   e544	KEYGT    e54b	ZERORT   e55a	
ZEROR2   e55d	FLGET    e560	REPETS   e570	KEYBFA   e574	
KEYBFD   e577	NEWKYS   e57e	REPTSW   e582	KEYST2   e584	
SETLP1   e58e	SETPL2   e595	SETPL3   e59e	SETPL4   e5a2	
KYBFSR   e5a6	FLASHS   e5b1	FLASHG   e5b2	FLASHA   e5b3	
FLASHD   e5b6	FLASHC   e5b7	L0D28    e5c0	FLASHO   e5c2	
FLASHE   e5c5	FLSHGT   e5cd	FLGTLP   e5d3	REPETF   e5e8	
FLSHL3   e5f6	FLGTL2   e5f9	FLSHRT   e602	KEYSEN   e60b	
KEYSN0   e60e	KEYSN1   e610	KEYSN2   e61d	KEYSN3   e627	
L0D9D    e62e	L0DA5    e636	L0DB1    e642	L0DB9    e64a	
NEWCEK   e64c	NEWPL1   e654	SAMECK   e662	SAMELP   e66a	
NEWFLG   e672	FLGLP1   e67a	FLGLP2   e690	FLGLP4   e69d	
FLGLP3   e69f	FLGLP5   e6a4	FLGLP6   e6a8	FLGLP9   e6b2	
FLGLP7   e6b6	FLGLP8   e6bd	KYBFST   e6c6	L0E4C    e6dd	
CTRLNO   e6ed	SETKY    e6fa	NONKEY   e6fd	NONKE?   e700	
SETKY2   e708	FUNCTN   e723	FUNCLP   e735	BFSTSB   e73e	
NONSET   e757	NORET    e759	CTL      e75a	NOINC1   e763	
JPHL     e767	CTLTBL   e768	ACCPRT1  e7a8	CTLLF    e7ba	
LOWEST   e7d7	MOVEN1   e7e4	MOVEN2   e7f3	SETAD    e7fb	
CTLCR    e814	CTLUP    e81a	CTLRHT   e823	RHTOK    e837	
CTLLFT   e83a	LFTOK    e84a	CTLHOM   e84e	CTLCLS   e856	
LOOP1    e868	CTLESC   e871	CTLNUL   e876	ESC      e877	
ESC3     e87d	XOK      e88d	YOK      e89a	ESC2     e8a0	
ESC1     e8aa	ESCEQ    e8bf	ESCT     e8c5	ESCTLP   e8d3	
ESCY     e8db	ESCYLP   e8df	CALCAD   e8f3	COPYCHR  e902	
XEVEN    e921	XODD     e94e	INCCSR   e979	FONT     e989	
CAPS     eb09	ESCMOD   eb0a	ESCEQY   eb0b	TIME     eb0c	
CSRX     eb0d	CSRY     eb0e	CSRAD    eb0f	CSRATT   eb11	
CSROUT   eb13	WIDTH    eb14	HEIGHT   eb15	VDAREA   eb17	
GMODEF   eb18	CURX     eb19	CURY     eb1a	OLDBUF   eb1b	
NEWBUF   eb25	NEWMOD   eb2e	LOCKMD   eb2f	POINT1   eb30	
POINT2   eb31	FUNBUF   eb32	KEYDT1   eb83	KEYDT2   ebcb	
DIRBF    ec13	BEGDAT   ec13	ALL00    ec93	ALL01    ecb2	
ALL02    ecd1	ALL03    ecf0	ALLHD1   ed0f	ALLHD2   ee0e	
CHK00    ef0d	CHK01    ef1d	CHK02    ef2d	CHK03    ef3d	
CHKHD2   ef4d	INKYBF   ef4d	CHKHD1   ef4d	TABBUF   ef8d	
VDISP    efad	DISKDATA f5ad	ENDDAT   f6ad	

No undefined symbol.
